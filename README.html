<!DOCTYPE html>
<html>
    <head>
        <!-- @see http://shadow2531.com/opera/testcases/datauri/data_uri_rules.html -->
        <meta charset="utf-8">
        <title>'data' URI Parsing Rules</title>
        <style>
            body {
                padding: 15px;
                font-family: monospace;
                background: beige;
                font-weight: bold;
            }
            li {
                margin-bottom: 20px;
            }
            li ol li {
                list-style: lower-alpha;
            }
            li ol li ol li {
                list-style: decimal;
            }
            li ol li ol li ol li {
                list-style: lower-alpha;
            }
            li ol li ol li ol li ol li {
                list-style: decimal;
            }
            li ol li ol li ol li ol li ol li {
                list-style: lower-alpha;
            }
        </style>
    </head>
    <body>
        <h1>'data' URI Parsing Rules</h1>
        <ol>
            <li>Let <code>URI</code> be the string representing the data URI.</li>
            <li>
                <p>If <code>URI</code> does not start with a case-insensitive "data:":</p>
                <ol>
                    <li>Throw a <code>MALFORMED_URI</code> exception.</li>
                </ol>
            </li>
            <li>
                <p>If <code>URI</code> does not contain a ",":</p>
                <ol>
                    <li>Throw a <code>MALFORMED_URI</code> exception.</li>
                </ol>
            </li>
            <li>Let <code>supportedContentEncodings</code> be an array of strings representing the supported content encodings. (<code>["base64"]</code> for example)</li>
            <li>Let <code>mimeType</code> be a string with the value "text/plain".</li>
            <li>Let <code>contentEncoding</code> be an empy string.</li>
            <li>Let <code>contentEncodingAlreadySet</code> be a boolean with a value of false.</li>
            <li>Let <code>supportedValues</code> be a map of string:string pairs where the first string in each pair represents the name of the supported value and the second string in each pair represents an empty string or default string value. (Example: <code>{"charset" : "", "filename" : "", "content-disposition" : ""}</code>)</li>
            <li>Let <code>supportedValueSetBits</code> be a map of string:bool pairs representing each of the names in <code>supportedValues</code> with each name set to false.</li>
            <li>Let <code>comma</code> be the position of the first "," found in <code>URI</code>.</li>
            <li>Let <code>temp</code> be the substring of <code>URI</code> from, and including, position 5 to, and excluding, the <code>comma</code> position. (between "data:" and first ",")</li>
            <li>Let <code>headers</code> be an array of strings returned by splitting <code>temp</code> by ";".</li>
            <li>
                <p>For each string <code>s</code> in <code>headers</code>:</p>
                <ol>
                    <li>Let <code>s</code> equal the lowercase version of <code>s</code></li>
                    <li>Let <code>eq</code> be the position result of searching for "=" in <code>s</code>.</li>
                    <li>Let <code>name</code> and <code>value</code> be empty strings.</li>
                    <li>
                        <p>If <code>eq</code> is not a valid position in <code>s</code>:</p>
                        <ol>
                            <li>Let <code>name</code> equal the result of percent-decoding <code>s</code>.</li>
                            <li>Let <code>name</code> equal the result of trimming leading and trailing white-space from <code>name</code>.</li>
                        </ol>
                    </li>
                    <li>
                        <p>Else:</p>
                        <ol>
                            <li>Let <code>name</code> equal the substring of <code>s</code> from position 0 to, but not including, position <code>eq</code>.</li>
                            <li>Let <code>name</code> equal the result of percent-decoding <code>name</code>.</li>
                            <li>Let <code>name</code> equal the result of trimmnig leading and trailing white-space from <code>name</code>.</li>
                            <li>Let <code>value</code> equal the substring of <code>s</code> from position <code>eq</code> + 1 to the end of <code>s</code>.</li>
                            <li>Let <code>value</code> equal the result of precent-decoding <code>value</code>.</li>
                            <li>Let <code>value</code> equal the result of trimming leading and trailing white-space from <code>value</code>.</li>
                        </ol>
                    </li>
                    <li>
                        <p>If <code>s</code> is the first element in <code>headers</code> and <code>eq</code> is not a valid position in <code>s</code> and the length of <code>name</code> is greater than 0:</p>
                        <ol>
                            <li>Let <code>mimeType</code> equal <code>name</code>.</li>
                        </ol>
                    </li>
                    <li>
                        <p>Else:</p>
                        <ol>
                            <li>
                                <p>If <code>eq</code> is not a valid position in <code>s</code>:</p>
                                <ol>
                                    <li>
                                        <p>If <code>name</code> is found case-insensitively in <code>supportedContentEncodings</code>:</p>
                                        <ol>
                                            <li>
                                                <p>If <code>contentEncodingAlreadySet</code> is false:</p>
                                                <ol>
                                                    <li>Let <code>contentEncoding</code> equal <code>name</code>.</li>
                                                    <li>Let <code>ContentEncodingAlreadySet</code> equal true.</li>
                                                </ol>
                                            </li>
                                        </ol>
                                    </li>
                                </ol>
                            </li>
                            <li>
                                <p>Else:</p>
                                <ol>
                                    <li>
                                        <p>If the length of <code>value</code> is greater than 0 and <code>name</code> is found case-insensitively in <code>supportedValues</code>:</p>
                                        <ol>
                                            <li>
                                                <p>If the corresponding value for <code>name</code> found (case-insensitivley) in <code>supportedValueSetBits</code> is false:</p>
                                                <ol>
                                                    <li>Let the corresponding value for <code>name</code> found (case-insensitively) in <code>supportedValues</code> equal <code>value</code>.</li>
                                                    <li>Let the corresponding value for <code>name</code> found (case-insensitively) in <code>supportedValueSetBits</code> equal true.</li>
                                                </ol>
                                            </li>
                                        </ol>
                                    </li>
                                </ol>
                            </li>
                        </ol>
                    </li>
                </ol>
            </li>
            <li>Let <code>data</code> be the substring of <code>URI</code> from position <code>comma</code> + 1 to the end of <code>URI</code>.</li>
            <li>Let <code>data</code> be the result of percent-decoding <code>data</code>.</li>
            <li>Let <code>dataURIObject</code> be an object consisting of the <code>mimeType</code>, <code>contentEncoding</code>, <code>data</code> and <code>supportedValues</code> objects.</li>
            <li>return <code>dataURIObject</code>.</li>
        </ol>
        <p><a href="parse_data_uri.html">Javascript Example</a></p>
        <p><a href="data_uri_syntax.html">Syntax Explanation</a> to go along with the rules.</p>
    </body>
</html>